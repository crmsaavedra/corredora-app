<link rel="stylesheet" href="/static/css/landing.css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700,800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.2/css/all.css" integrity="sha384-/rXc/GQVaYpyDdyxK+ecHPVYJSN9bmVFBvjA/9eOB+pb3F2w2N6fc5qB9Ew5yIns" crossorigin="anonymous">

<style>
    .container { max-width: 1000px; width: 100%; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
    .container_2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; max-width: 1000px; width: 100%; padding: 20px; }
    .property-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; }
    .property-info { display: flex; flex-wrap: wrap; gap: 20px; }
    .property-info img { max-width: 100%; border-radius: 5px; cursor: pointer; }
    .badge { display: inline-block; color: white; padding: 5px 10px; font-weight: bold; border-radius: 5px; }
    .price { font-size: 32px; font-weight: bold; color: #000; margin: 10px 0; }
    .details { list-style: none; padding: 0; }
    .details li { display: flex; align-items: center; font-size: 16px; margin-bottom: 10px; }
    .gallery { display: flex; gap: 10px; margin-top: 20px; overflow-x: auto; padding-bottom: 10px; }
    .gallery img { width: 150px; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer; }
    .gallery img:hover { transform: scale(1.1); transition: 0.3s; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; }
    .modal img { max-width: 90%; max-height: 90%; border-radius: 5px; }
    .close, .prev, .next { position: absolute; font-size: 30px; color: white; cursor: pointer; top: 50%; transform: translateY(-50%); }
    .close { top: 20px; right: 30px; }
    .prev { left: 20px; }
    .next { right: 20px; }
    @media (max-width: 768px) { .property-info { flex-direction: column; } }
    .container-plus{ display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f5f5f5; flex-direction: column; }
    .card { border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: relative; background-color: white; }
    .card_2 { border-radius: 10px; overflow: hidden; position: relative; background-color: white; }
    .card img { width: 100%; height: auto; }
    .badge { position: absolute; top: 10px; left: 10px; color: white; padding: 5px 10px; font-weight: bold; border-radius: 5px; }
    .card-content { padding: 15px; }
    .title { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
    .price { font-size: 24px; font-weight: bold; color: #000; margin-bottom: 10px; }
    .location { display: flex; align-items: center; color: #555; font-size: 14px; }
    .location::before { content: '\1F4CD'; margin-right: 5px; }
</style>

<% 
    let mainImage = "https://via.placeholder.com/800x400?text=Sin+Imagen";
    if (propiedad && propiedad.fotos && propiedad.fotos.length > 0 && propiedad.fotos[0]) {
        mainImage = propiedad.fotos[0].replace("./public", "/static");
    }
    
    // Protección para objetos anidados
    const detalles = propiedad.detalles || { tipo_acuerdo: 'N/A', habitaciones: 0, baños: 0, estado: 'N/A' };
%>

<div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden mt-6">
    <div class="card_2 mx-4 my-2">
        <img src="<%= mainImage %>" class="w-full h-64 object-cover" alt="Foto de la propiedad" onclick="openModal(0)">
        <div class="badge" id="banner"></div>
    </div>


    <div class="p-6">
        <h2 class="text-2xl font-bold text-gray-800"><%= propiedad.nombre || 'Sin Nombre' %></h2>
        <p class="mt-2 text-3xl font-semibold text-green-600" id="price"></p>
    </div>


    <div class="border-t">
        <div class="p-4 border-b flex justify-between"><span class="font-semibold"><i class="fa-solid fa-tags mr-2"></i>Tipo:</span> <%= detalles.tipo_acuerdo %></div>
        <div class="p-4 border-b flex justify-between"><span class="font-semibold"><i class="fa-solid fa-location-dot mr-2"></i>Ubicación:</span> <%= propiedad.region || '' %>, <%= propiedad.comuna || '' %></div>
        <div class="p-4 border-b flex justify-between"><span class="font-semibold"><i class="fa-solid fa-bed mr-2"></i>Habitaciones:</span> <%= detalles.habitaciones %></div>
        <div class="p-4 border-b flex justify-between"><span class="font-semibold"><i class="fa-solid fa-bath mr-2"></i>Baños:</span> <%= detalles.baños %></div>
        <div class="p-4 border-b flex justify-between"><span class="font-semibold"><i class="fa-solid fa-calendar-days mr-2"></i>Publicado el:</span> <h1 id="fecha_creado">--/--/----</h1></div>
        <div class="p-4 flex justify-between"><span class="font-semibold"><i class="fa-solid fa-phone mr-2"></i>Teléfono:</span> +569 <%= propiedad.contacto || '00000000' %></div>
    </div>

    <div class="p-6">
        <p class="text-gray-700"><%= propiedad.descripcion || 'Sin descripción disponible.' %></p>
    </div>

    <div class="p-6">
        <h3 class="text-xl font-bold mb-4"><i class="fa-solid fa-image mr-2"></i>Galería de imágenes</h3>
        <div class="grid grid-cols-3 gap-4" id="galeria_fotos"></div>
    </div>
</main>

<div class="modal" id="imageModal">
    <span class="close" onclick="closeModal()">&times;</span>
    <span class="prev" onclick="prevImage()">&#10094;</span>
    <img id="modalImg">
    <span class="next" onclick="nextImage()">&#10095;</span>
</div>

<section class="my-5">
    <div class="contenedor_2">
        <h2 class="titulo"><a name="portafolio">Propiedades destacadas</a></h2>
        <div class="galeria-port" id="galeria-port"></div>
    </div>
</section>


<script>
    // Inicialización segura de variables
    let aleatorios = <%- JSON.stringify(typeof aleatorios !== 'undefined' ? aleatorios : []) %>;
    let propiedad = <%- JSON.stringify(typeof propiedad !== 'undefined' ? propiedad : {}) %>;

    // Función auxiliar para formatear precios
    function formatPrice(price, currency) {
        if (!price) return "$0";
        try {
            if (currency === "UF") {
                const formatter = new Intl.NumberFormat('es-CL', {
                    style: 'currency', currency: "CLP", trailingZeroDisplay: 'stripIfInteger'
                });
                return formatter.format(price).replace("$", "") + " UF";
            } else {
                const formatter = new Intl.NumberFormat('es-CL', {
                    style: 'currency', currency: currency || "CLP", trailingZeroDisplay: 'stripIfInteger'
                });
                return formatter.format(price);
            }
        } catch (e) {
            return price;
        }
    }

    // --- Lógica para Propiedades Destacadas (Aleatorios) ---
    let galeria_port = document.getElementById("galeria-port");
    galeria_port.innerHTML = "";

    if (Array.isArray(aleatorios)) {
        aleatorios.forEach(item => {
            const det = item.detalles || {};
            let disponible = true;
            if (det.estado === "ARRENDADO" || det.estado === "VENDIDO") {
                disponible = false;
            }

            let color = "bg-green-500";
            let msg = det.tipo_acuerdo || "N/A";

            if (!disponible) {
                color = "bg-red-500";
                msg = det.estado;
            }

            // Imagen segura
            let thumb = "https://via.placeholder.com/300x200?text=No+Image";
            if(item.fotos && item.fotos.length > 0 && item.fotos[0]) {
                thumb = item.fotos[0].replace("./public", "/static");
            }

            const precioFmt = formatPrice(item.price, item.tipo_moneda);

            galeria_port.innerHTML += `
                <a href="/propiedad/${item._id}" class="card mx-4 my-2" id="carta_${item._id}">
                    <img src="${thumb}" alt="${item.nombre}">
                    <div class="badge ${color}">${msg}</div>
                    <div class="card-content">
                        <div class="title">${item.nombre}</div>
                        <div class="price">${precioFmt}</div>
                        <div class="location">${item.comuna || ''}, ${item.provincia || ''}, ${item.region || ''}</div>
                    </div>
                </a>
            `;
        });
    }

    // --- Lógica para Propiedad Principal ---
    if (propiedad && Object.keys(propiedad).length > 0) {
        // Precio
        document.getElementById("price").innerHTML = formatPrice(propiedad.price, propiedad.tipo_moneda);

        // Fecha
        if (propiedad.createdAt) {
            const today = new Date(propiedad.createdAt);
            const yyyy = today.getFullYear();
            let mm = today.getMonth() + 1;
            let dd = today.getDate();

            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            document.getElementById("fecha_creado").innerHTML = dd + '/' + mm + '/' + yyyy;
        }

        // Galería
        const galeria = document.getElementById("galeria_fotos");
        let images = [];
        
        if (propiedad.fotos && Array.isArray(propiedad.fotos)) {
            propiedad.fotos.forEach((foto, i) => {
                // Validación para evitar replace en null
                if(foto) {
                    let link = foto.replace("./public", "/static");
                    images.push(link);
                    galeria.innerHTML += `
                        <img src="${link}" alt="Foto ${i}" class="w-full h-32 object-cover cursor-pointer hover:opacity-80 transition" onclick="openModal(${i})">
                    `;
                }
            });
        }

        // Banner de estado
        const detMain = propiedad.detalles || {};
        let dispMain = true;
        if (detMain.estado === "ARRENDADO" || detMain.estado === "VENDIDO") {
            dispMain = false;
        }

        let colorMain = "bg-green-500";
        let msgMain = detMain.tipo_acuerdo || "";

        if (!dispMain) {
            colorMain = "bg-red-500";
            msgMain = detMain.estado;
        }

        const banner = document.getElementById("banner");
        banner.classList.add(colorMain);
        banner.innerHTML = msgMain;

        // --- Lógica del Modal ---
        let currentIndex = 0;
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('modalImg');

        window.openModal = function(index) {
            if (images.length === 0) return;
            currentIndex = index;
            modalImg.src = images[currentIndex];
            modal.style.display = 'flex';
        }

        window.closeModal = function() {
            modal.style.display = 'none';
        }

        window.prevImage = function() {
            if (images.length === 0) return;
            currentIndex = (currentIndex > 0) ? currentIndex - 1 : images.length - 1;
            modalImg.src = images[currentIndex];
        }

        window.nextImage = function() {
            if (images.length === 0) return;
            currentIndex = (currentIndex < images.length - 1) ? currentIndex + 1 : 0;
            modalImg.src = images[currentIndex];
        }
        
        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                window.closeModal();
            }
        });
    }
</script>